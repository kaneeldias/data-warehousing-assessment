services:
  mssql-server:
    image: mcr.microsoft.com/mssql/server:2025-latest
    container_name: mssql_server
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "Test@123"
      MSSQL_PID: "Developer"
      MSSQL_AGENT_ENABLED: "true"
    ports:
      - "1433:1433"
    volumes:
      - mssql-data:/var/opt/mssql
      - ./data:/var/opt/mssql/import/data:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P \"$${SA_PASSWORD}\" -Q \"SELECT 1\" >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  init-db:
    image: mcr.microsoft.com/mssql-tools
    container_name: mssql_init_db
    depends_on:
      - mssql-server
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "Test@123"
    volumes:
      - ./init-scripts:/usr/config:ro
    entrypoint: ["/bin/bash", "-lc"]
    command:
      - |
        until /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -Q "SELECT 1" >/dev/null 2>&1; do echo "waiting for mssql-server..."; sleep 2; done; \
        echo "running init scripts"; \
        /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -i /usr/config/oltp.sql; \
        /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -i /usr/config/olap.sql; \
        /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -i /usr/config/enable_cdc.sql; \
        /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -i /usr/config/manual_cdc.sql; \
        /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -i /usr/config/market_basket.sql; \
        /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -i /usr/config/scd.sql; \
        /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -i /usr/config/materialized_views.sql; \
        /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -i /usr/config/hierarchy.sql; \
        /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -i /usr/config/employees.sql; \
        /opt/mssql-tools/bin/sqlcmd -S mssql-server -U sa -P "$${SA_PASSWORD}" -i /usr/config/indexes.sql; \
    restart: "no"

  oracle-db-server:
    image: container-registry.oracle.com/database/enterprise:21.3.0.0
    container_name: oracle_db_server
    environment:
      ORACLE_PWD: "test123"
    ports:
      - "1521:1521"
    volumes:
      - oracle-data:/opt/oracle/oradata
      - ./data:/opt/oracle/import/data:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "echo 'SELECT 1 FROM dual;' | sqlplus -s system/$${ORACLE_PASSWORD}@localhost:1521/orclpdb1 | grep -q 1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

volumes:
  mssql-data:
    driver: local
  oracle-data:
    driver: local
